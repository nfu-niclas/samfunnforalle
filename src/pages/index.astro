---
// 1. Importer nødvendige verktøy
import sanityClient from '@sanity/client';
import imageUrlBuilder from '@sanity/image-url';

// 2. Definer GROQ-spørringen (Hent alle artikler, sortert etter nyeste først)
// Vi "derefererer" (author->) for å hente forfatternavnet direkte.
const postQuery = `*[_type == "post"] | order(publishedAt desc) {
  title,
  'slug': slug.current,
  excerpt,
  publishedAt,
  mainImage,
  author->{name}
}`;

// 3. Hent data fra Sanity
const client = sanityClient({
  projectId: 'yhvccqet', // Husk å bytte ut
  dataset: 'production',
  apiVersion: '2021-10-21',
  useCdn: true,
});
const posts = await client.fetch(postQuery);

// 4. Konfigurer bildebyggeren
const builder = imageUrlBuilder(client);

function urlFor(source: any) {
  return builder.image(source);
}

// 5. Formater dato
function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('nb-NO', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}
---

<html lang="no">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Samfunn For Alle - Nyheter</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .article-list { list-style: none; padding: 0; }
        .article-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; display: flex; gap: 20px; }
        .article-card img { width: 150px; height: 100px; object-fit: cover; }
        .article-info h2 { margin-top: 0; }
        .meta-info { font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <header>
        <h1>Samfunn For Alle</h1>
        <p>Din kilde til nyheter og debatt.</p>
    </header>

    <main>
        <h2>Siste Artikler</h2>
        <ul class="article-list">
            {posts.map((post: any) => (
                <li class="article-card">
                    {post.mainImage && (
                        <img 
                            src={urlFor(post.mainImage).width(300).height(200).url()} 
                            alt={`Hovedbilde for ${post.title}`}
                        />
                    )}
                    <div class="article-info">
                        <h2>
                            {/* Vi lenker til sluggen som blir URLen (men denne siden eksisterer ikke ennå!) */}
                            <a href={`/${post.slug}`}>{post.title}</a>
                        </h2>
                        <p class="meta-info">
                            Publisert: {formatDate(post.publishedAt)} | Av: 
                            {post.author ? post.author.name : 'Ukjent forfatter'}
                        </p>
                        <p>{post.excerpt}</p>
                    </div>
                </li>
            ))}
            {posts.length === 0 && <p>Ingen artikler funnet i Sanity. Opprett din første artikkel i Studio!</p>}
        </ul>
    </main>

    <footer>
        <p>&copy; {new Date().getFullYear()} Samfunn For Alle.</p>
    </footer>
</body>
</html>